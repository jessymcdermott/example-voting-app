#im dense
name: Sysdig Image Scan

on:
  push:
    branches: [main]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build vote image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USER }}/vote:latest ./vote
        docker push ${{ secrets.DOCKERHUB_USER }}/vote:latest

    - name: Build result image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USER }}/result:latest ./result
        docker push ${{ secrets.DOCKERHUB_USER }}/result:latest

    - name: Build worker image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USER }}/worker:latest ./worker
        docker push ${{ secrets.DOCKERHUB_USER }}/worker:latest

    - name: Install Sysdig CLI Scanner
      run: |
        VERSION="1.24.2"
        curl -LO "https://download.sysdig.com/scanning/bin/sysdig-cli-scanner/${VERSION}/linux/amd64/sysdig-cli-scanner"
        chmod +x sysdig-cli-scanner
        sudo mv sysdig-cli-scanner /usr/local/bin/
        sysdig-cli-scanner --version

    - name: Scan vote image with Sysdig
      env:
        SYSDIG_API_TOKEN: ${{ secrets.SYSDIG_API_TOKEN }}
        SYSDIG_REGION: us4
        SYSDIG_APIURL: https://api.us4.sysdig.com
      run: |
        sysdig-cli-scanner image scan ${{ secrets.DOCKERHUB_USER }}/vote:latest

    - name: Scan result image with Sysdig
      env:
        SYSDIG_API_TOKEN: ${{ secrets.SYSDIG_API_TOKEN }}
        SYSDIG_REGION: us4
      run: |
        sysdig-cli-scanner image scan ${{ secrets.DOCKERHUB_USER }}/result:latest

    - name: Scan worker image with Sysdig
      env:
        SYSDIG_API_TOKEN: ${{ secrets.SYSDIG_API_TOKEN }}
        SYSDIG_REGION: us4
      run: |
        sysdig-cli-scanner image scan ${{ secrets.DOCKERHUB_USER }}/worker:latest
